// Generated by CoffeeScript 1.4.0
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(['jquery.xml2json'], function(xml) {
  var BookView, BooksCollectionView, GoodReadsData, HEADER_PADDING, MainPage, MainRouter, READING_TEMPLATES, ReadingWindow, WindowView;
  READING_TEMPLATES = $('.reading-templates');
  HEADER_PADDING = 45;
  MainRouter = (function(_super) {

    __extends(MainRouter, _super);

    function MainRouter() {
      return MainRouter.__super__.constructor.apply(this, arguments);
    }

    MainRouter.prototype.routes = {
      'bio/': 'showBio',
      'hacker/': 'showHacker'
    };

    MainRouter.prototype.initialize = function() {
      this.mainPage = new MainPage;
      this.reading = new ReadingWindow;
      return console.log('yay');
    };

    MainRouter.prototype.showBio = function() {
      return $(window).scrollTop(20);
    };

    return MainRouter;

  })(Backbone.Router);
  MainPage = (function(_super) {

    __extends(MainPage, _super);

    function MainPage() {
      return MainPage.__super__.constructor.apply(this, arguments);
    }

    MainPage.prototype.el = 'body';

    MainPage.prototype.initialize = function() {
      _.bindAll(this, 'detectScroll');
      return this.detectScroll();
    };

    MainPage.prototype.detectScroll = function(event) {
      var $hackerHeader, hackerTop,
        _this = this;
      this.headerH = $('.header-main').outerHeight();
      $hackerHeader = $('.header-hacker');
      hackerTop = $hackerHeader.offset().top - (this.headerH - HEADER_PADDING);
      return $(window).scroll(function(event) {
        var hackerMovement, top;
        top = $(window).scrollTop();
        hackerMovement = $('.header-hacker').offset().top;
        console.log(top, hackerTop, _this.headerH);
        if (top >= hackerTop) {
          $('.header-offset').removeClass('absolute');
          $hackerHeader.addClass('fixed');
          $('.nav').addClass('fixed orange');
          return $('.logo').addClass('fixed');
        } else {
          $('.header-offset').addClass('absolute');
          $hackerHeader.removeClass('fixed');
          $('.nav').removeClass('fixed orange');
          return $('.logo').removeClass('fixed');
        }
      });
    };

    return MainPage;

  })(Backbone.Marionette.Layout);
  WindowView = (function(_super) {

    __extends(WindowView, _super);

    function WindowView() {
      return WindowView.__super__.constructor.apply(this, arguments);
    }

    WindowView.prototype.events = {
      'click': 'toggleWindow'
    };

    WindowView.prototype.initialize = function() {
      return this.render();
    };

    WindowView.prototype.toggleWindow = function(event) {
      return (this.$('.window')).toggleClass('open');
    };

    return WindowView;

  })(Backbone.Marionette.Layout);
  ReadingWindow = (function(_super) {

    __extends(ReadingWindow, _super);

    function ReadingWindow() {
      return ReadingWindow.__super__.constructor.apply(this, arguments);
    }

    ReadingWindow.prototype.className = 'reading-window';

    ReadingWindow.prototype.template = _.template($('#reading-template').html());

    ReadingWindow.prototype.el = '.reading';

    ReadingWindow.prototype.url = 'http://www.goodreads.com/review/list/5406984.xml?key=Nkya34MwrAyEZ7cnbMzqA&v=2&shelf=read';

    ReadingWindow.prototype.regions = {
      books: '.book-list'
    };

    ReadingWindow.prototype.initialize = function() {
      this.getReadingData();
      return ReadingWindow.__super__.initialize.apply(this, arguments);
    };

    ReadingWindow.prototype.toggleWindow = function(event) {
      this.books.show(this.booksCollectionView);
      (this.$('small')).toggleClass('invisible');
      return ReadingWindow.__super__.toggleWindow.apply(this, arguments);
    };

    ReadingWindow.prototype.getReadingData = function() {
      var _this = this;
      return $.get(this.url, function(xml) {
        var data;
        data = $.xml2json(xml);
        _this.model = new Backbone.Model(data.reviews);
        return _this.prepareData();
      });
    };

    ReadingWindow.prototype.prepareData = function() {
      var image, review, reviews, _i, _len;
      reviews = this.model.get('review');
      for (_i = 0, _len = reviews.length; _i < _len; _i++) {
        review = reviews[_i];
        image = review.book.image_url;
        image = image.replace(/m\/(?=\d)/g, 'l/');
        review.book.image_url = image;
      }
      this.bookList = new Backbone.Collection(reviews);
      return this.renderBooks();
    };

    ReadingWindow.prototype.renderBooks = function() {
      return this.booksCollectionView = new BooksCollectionView({
        collection: this.bookList
      });
    };

    return ReadingWindow;

  })(WindowView);
  BookView = (function(_super) {

    __extends(BookView, _super);

    function BookView() {
      return BookView.__super__.constructor.apply(this, arguments);
    }

    BookView.prototype.template = _.template($('#books-template').html());

    return BookView;

  })(Backbone.Marionette.ItemView);
  BooksCollectionView = (function(_super) {

    __extends(BooksCollectionView, _super);

    function BooksCollectionView() {
      return BooksCollectionView.__super__.constructor.apply(this, arguments);
    }

    BooksCollectionView.prototype.itemView = BookView;

    return BooksCollectionView;

  })(Backbone.Marionette.CollectionView);
  GoodReadsData = (function(_super) {

    __extends(GoodReadsData, _super);

    function GoodReadsData() {
      return GoodReadsData.__super__.constructor.apply(this, arguments);
    }

    GoodReadsData.prototype.url = 'http://www.goodreads.com/user/show/5406984.xml?key=Nkya34MwrAyEZ7cnbMzqA';

    GoodReadsData.prototype.fetch = function(data) {
      var results;
      results = $.xml2json(data.results);
      return results;
    };

    return GoodReadsData;

  })(Backbone.Model);
  return new MainRouter;
});
