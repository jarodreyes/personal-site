// Generated by CoffeeScript 1.5.0
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

define(['window', 'jquery.xml2json'], function(WindowView, xml2json) {
  var BookView, BooksCollectionView, ReadingWindow;
  ReadingWindow = (function(_super) {

    __extends(ReadingWindow, _super);

    function ReadingWindow() {
      ReadingWindow.__super__.constructor.apply(this, arguments);
    }

    ReadingWindow.prototype.className = 'reading-window';

    ReadingWindow.prototype.template = _.template($('#reading-template').html());

    ReadingWindow.prototype.el = '.reading';

    ReadingWindow.prototype.url = 'http://www.goodreads.com/review/list/5406984.xml?key=Nkya34MwrAyEZ7cnbMzqA&v=2&shelf=read';

    ReadingWindow.prototype.regions = {
      books: '.book-list'
    };

    ReadingWindow.prototype.initialize = function() {
      this.getReadingData();
      return ReadingWindow.__super__.initialize.apply(this, arguments);
    };

    ReadingWindow.prototype.toggleWindow = function(event) {
      this.books.show(this.booksCollectionView);
      (this.$('small')).toggleClass('invisible');
      return ReadingWindow.__super__.toggleWindow.apply(this, arguments);
    };

    ReadingWindow.prototype.getReadingData = function() {
      var _this = this;
      return $.get(this.url, function(xml) {
        var data;
        data = $.xml2json(xml);
        _this.model = new Backbone.Model(data.reviews);
        return _this.prepareData();
      });
    };

    ReadingWindow.prototype.prepareData = function() {
      var image, review, reviews, _i, _len;
      reviews = this.model.get('review');
      for (_i = 0, _len = reviews.length; _i < _len; _i++) {
        review = reviews[_i];
        image = review.book.image_url;
        image = image.replace(/m\/(?=\d)/g, 'l/');
        review.book.image_url = image;
      }
      this.bookList = new Backbone.Collection(reviews);
      return this.renderBooks();
    };

    ReadingWindow.prototype.renderBooks = function() {
      return this.booksCollectionView = new BooksCollectionView({
        collection: this.bookList
      });
    };

    return ReadingWindow;

  })(WindowView);
  BookView = (function(_super) {

    __extends(BookView, _super);

    function BookView() {
      BookView.__super__.constructor.apply(this, arguments);
    }

    BookView.prototype.template = _.template($('#books-template').html());

    return BookView;

  })(Backbone.Marionette.ItemView);
  BooksCollectionView = (function(_super) {

    __extends(BooksCollectionView, _super);

    function BooksCollectionView() {
      BooksCollectionView.__super__.constructor.apply(this, arguments);
    }

    BooksCollectionView.prototype.itemView = BookView;

    return BooksCollectionView;

  })(Backbone.Marionette.CollectionView);
  return ReadingWindow;
});
